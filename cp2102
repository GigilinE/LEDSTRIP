esphome:
  name: led_controller
  platform: ESP32
  board: nodemcu-32s

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Cp2102 Fallback Hotspot"
    password: !secret ap_password

i2c:
  sda: 21
  scl: 22
  scan: True

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_en_key

captive_portal:

pca9685:
  id: pca9685_extender
  frequency: 1000 Hz

output:
  - platform: pca9685
    id: output_red
    channel: 0
  - platform: pca9685
    id: output_green
    channel: 1
  - platform: pca9685
    id: output_blue
    channel: 2

ota:
  password: "e9f17baae6503d6427f99aafd5c68ac3"

globals:
  - id: effect_in_progress
    type: bool
    restore_value: no
    initial_value: 'false'

light:
  - platform: rgb
    name: "LED Strip RGB"
    id: led_strip_rgb
    red: output_red
    green: output_green
    blue: output_blue
  - platform: neopixelbus
    variant: WS2811
    pin: GPIO5
    num_leds: 420
    id: led_strip
    name: "LED Strip"
    effects:
      - addressable_lambda:
          name: Effetto di Caricamento
          update_interval: 50ms
          lambda: |-
            static int lit_leds = 0;
            if (lit_leds == 0) {
              id(effect_in_progress) = true;
            }
            if (!id(led_strip).state.is_on()) {
              it.all() = light::ESPColor::BLACK;
              lit_leds = 0;
              id(effect_in_progress) = false;
            } else if (lit_leds < it.size()) {
              it[lit_leds++] = light::ESPColor::WHITE;
            } 
            on_turn_on:
              then:
                if:
                  condition:
                    not:
                      global.value: effect_in_progress
                  then:
                    - light.turn_off: led_strip
                    - delay: 500ms
                    - light.turn_on:
                        id: led_strip
                        effect: "Effetto di Caricamento"
